# AI対応MCP Tool 要件定義書

## 概要
既存のMCP Tool（`getStockHistory`）を完全に差し替え、TechnicalAnalyzerが返すデータをAIが理解しやすい形式で提供する新しいツールを実装する。

## 機能要件

### 1. ツール仕様
- **ツール名**: `getStockAnalysis` （既存の`getStockHistory`を置き換え）
- **説明**: 株式銘柄の技術的分析結果をAI理解しやすい形式で提供

### 2. 入力パラメータ
- **symbol** (必須): 
  - 型: string
  - 説明: 株式銘柄コード
  - 形式仕様: 
    - 米国株: "AAPL", "GOOGL", "MSFT" など（ティッカーシンボル）
    - 日本株: "7203.T", "6758.T", "9984.T" など（4桁数字 + ".T"）
    - その他の市場: Yahoo Finance対応形式（例: "BTC-USD", "EURUSD=X"）
- **days** (オプション):
  - 型: number
  - デフォルト: 7
  - 説明: 直近何日分の価格推移データを返すか
  - 範囲: 1-365日

### 3. 出力形式
AIが理解しやすい構造化された日本語レポート形式で返す：

```
## 銘柄分析レポート: {symbol}

### 基本情報
- 銘柄: {symbol} ({companyName})
- 分析期間: 直近{days}日間（内部計算用: 1年分データ使用）
- 分析日時: {timestamp}

### 価格情報
- 現在価格: ¥{current_price} ({change} / {change_percent}%)
- 価格推移データ: {days}日分の詳細データ

### 財務指標
- 時価総額: ¥{marketCap}
- PER（実績）: {trailingPE}
- PER（予想）: {forwardPE}
- PBR: {priceToBook}
- ROE: {returnOnEquity}%
- EPS成長率: {earningsGrowth}%
- 配当利回り: {dividendYield}%
- 自己資本比率: {equityRatio}%
- データ充足率: {validCount}/{totalCount} ({percentage}%)

### テクニカル指標

**移動平均線:**
- 25日線: ¥{ma25} (現在価格との関係: {上位/下位})
- 50日線: ¥{ma50} (現在価格との関係: {上位/下位})
- 200日線: ¥{ma200} (現在価格との関係: {上位/下位})
- トレンド判定: {📈上昇/📉下降/➡️横ばい}

**RSI (相対力指数):**
- 14日RSI: {rsi14} ({🔴買われすぎ/🟢売られすぎ/⚪通常})
- 21日RSI: {rsi21} ({🔴買われすぎ/🟢売られすぎ/⚪通常})
- RSI収束/発散: {🔄収束/↗️発散/➡️安定}
- 総合推奨: {🟢強い買い/💚買い/🟡保持/🔴売り/💀強い売り}

**移動平均乖離率:**
- 25日MA乖離: {+/-}{deviation}% (MA: ¥{movingAverage})
- 50日MA乖離: {+/-}{deviation}% (MA: ¥{movingAverage})
- 200日MA乖離: {+/-}{deviation}% (MA: ¥{movingAverage})
- 総合シグナル: {🔴大幅上振れ/🟠上振れ/🟢正常範囲/🟡下振れ/🔵大幅下振れ}
- 信頼度: {🔴高/🟡中/🔵低}

**MACD:**
- MACD: {macd}
- シグナル: {signal}
- ヒストグラム: {histogram}
- シグナル: {🟢強気/🔴弱気/⚪中立}

**ボリンジャーバンド:**
- 上部バンド: ¥{upper}
- 中央線: ¥{middle}
- 下部バンド: ¥{lower}
- バンド幅: {bandwidth}%
- %B: {percentB}%
- シグナル: {🟢買い/🔴売り/⚪中立}
- ボラティリティ: {🔥高い/➡️通常/❄️低い}

**ストキャスティクス:**
- %K値: {k}
- %D値: {d}
- シグナル: {🟢買い/🔴売り/⚪中立}
- 状態: {🔴買われすぎ/🟢売られすぎ/⚪通常}

**ゴールデンクロス・デッドクロス検出:**
- クロスタイプ: {🟡ゴールデンクロス/💀デッドクロス/➡️クロスなし}
- 短期MA(25日): ¥{shortMA}
- 長期MA(50日): ¥{longMA}
- 強度: {💪強い/👍中程度/👎弱い}
- 継続日数: {confirmationDays}日

**出来高分析:**
- 平均出来高: {averageVolume}
- 相対出来高: {relativeVolume}倍
- トレンド: {📈増加/📉減少/➡️安定}
- 急増検出: {🔴あり/⚪なし}
- 価格相関: {💪強い/👍中程度/👎弱い}
- 蓄積判定: {🟢蓄積/🔴分散/⚪中立}
- チャイキンMF: {cmf}

**VWAP (出来高加重平均価格):**
- VWAP: ¥{vwap}
- 上部バンド: ¥{upperBand}
- 下部バンド: ¥{lowerBand}
- 価格位置: {📈上位/📉下位/➡️付近}
- シグナル強度: {💪強い/👍中程度/👎弱い}
- トレンド: {📈上昇/📉下降/➡️横ばい}
- ブレイクアウト: {🚀上昇ブレイク/💥下落ブレイク/⚪ブレイクなし}

### 統合シグナル分析
- **トレンド:** {📈上昇/📉下降/➡️横ばい}
- **モメンタム:** {🟢ポジティブ/🔴ネガティブ/⚪ニュートラル}
- **強度:** {💪強い/👍中程度/👎弱い}
```

### 4. 内部データ取得
- Yahoo Finance APIから1年分のデータを取得（指標計算に必要な期間を確保）
- 出力は指定された日数分のみに制限

## 非機能要件

### 1. パフォーマンス
- APIレスポンス時間: 5秒以内
- データ取得期間: 内部的に1年分（十分な指標計算のため）

### 2. エラーハンドリング
- 無効な銘柄コード: 適切なエラーメッセージ
- APIエラー: ユーザーフレンドリーなエラー表示
- データ不足: 計算可能な指標のみ表示

### 3. 互換性
- 既存の`getStockHistory`ツールは完全に削除
- 既存のTechnicalAnalyzerライブラリを活用

## 活用する既存機能
spike/spike_all_features.ts で確認された全機能を活用：

### 実装する機能
- **財務指標:** 企業財務指標 (時価総額・PER・PBR・ROE・配当利回り等) + データ充足率・欠損項目の検証
- **基本指標:** 移動平均線 (25日/50日/200日) + トレンド判定、RSI拡張版 (14日/21日) + 収束発散分析 + 総合推奨、移動平均乖離率 (25日/50日/200日) + 総合シグナル + 信頼度、MACD (12-26-9設定) + シグナル判定
- **拡張指標:** ボリンジャーバンド (20日±2σ) + ボラティリティ判定、ストキャスティクス (14-3設定) + 買われすぎ/売られすぎ、ゴールデンクロス・デッドクロス検出 + 強度・継続日数、出来高分析 (相対出来高・蓄積判定・チャイキンMF)、VWAP + バンド + ブレイクアウト検出

### 統合分析
- TechnicalAnalyzer.analyzeStock() の総合判定機能
- 日本語シグナル変換 (絵文字付き)

## 制約事項
- 投資アドバイスではなく、技術的分析の参考情報として提供
- リアルタイムデータではなく、直近の終値ベース
- Yahoo Finance APIの制限に従う
- 指標計算に必要な最小データ数の確保が前提

## 成功基準
1. spike_all_features.ts の全機能を過不足なく包含
2. AIが理解しやすい日本語+絵文字での構造化レポート出力
3. 既存 getStockHistory ツールからの完全移行
4. エラーハンドリングの改善（データ不足時の適切な表示）
5. レスポンス性能の維持（5秒以内）