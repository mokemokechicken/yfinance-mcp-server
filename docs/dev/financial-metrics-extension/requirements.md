# 財務指標拡張機能 - 要件定義書

## 1. 概要
既存のテクニカル指標ライブラリに加えて、企業の財務指標、バリュエーション指標、テクニカル指標の追加実装を行う。

## 2. 追加する指標の分類と実装可否

### 2.1 テクニカル指標（既存ライブラリ拡張）
- **移動平均乖離率**: 25期間、50期間、200期間 ✅ 実装可能
- **RSI**: 14期間、21期間（既存RSI計算ロジックを活用） ✅ 実装可能

### 2.2 財務・バリュエーション指標（Yahoo Finance API利用）
| 指標名 | 実装可否 | データソース | 備考 |
|--------|----------|--------------|------|
| 時価総額 | ✅ 可能 | `price.marketCap` または `summaryDetail.marketCap` | |
| PER（実績） | ✅ 可能 | `summaryDetail.trailingPE` | |
| PER（予想） | ✅ 可能 | `defaultKeyStatistics.forwardPE` | |
| PBR | ✅ 可能 | `defaultKeyStatistics.priceToBook` | |
| ROE | ✅ 可能 | `financialData.returnOnEquity` | |
| EPS成長率 | ✅ 可能 | `financialData.earningsGrowth` | YoY EPS成長率 |
| 配当利回り | ✅ 可能 | `summaryDetail.dividendYield` | ×100で%換算が必要 |
| 自己資本比率 | ⚠️ 要計算 | `balanceSheetHistory` | totalStockholderEquity ÷ totalAssets |

### 2.3 信用取引指標
| 指標名 | 実装可否 | 備考 |
|--------|----------|------|
| 信用残 | ❌ 不可能 | Yahoo Finance APIでは提供されていない |
| 前週比 | ❌ 不可能 | 同上 |
| 信用倍率 | ❌ 不可能 | 同上 |

**信用取引指標について**: これらの指標は日本株特有のデータで、Yahoo Finance APIでは提供されていないため、今回の実装対象から除外する。

## 3. 機能要件

### 3.1 テクニカル指標の拡張
- **移動平均乖離率計算**: 株価が移動平均線からどの程度乖離しているかを%で算出
  - 計算式: `(現在価格 - 移動平均価格) / 移動平均価格 × 100`
  - 対象期間: 25日、50日、200日
- **RSI計算の期間拡張**: 既存のRSI計算ロジックを14日・21日期間に対応

### 3.2 財務指標の取得
- **quoteSummary API活用**: 複数の財務指標を効率的に一括取得
- **必要なmodules**: `price`, `summaryDetail`, `defaultKeyStatistics`, `financialData`, `balanceSheetHistory`
- **エラーハンドリング**: APIエラーや欠損データに対する適切な処理

### 3.3 自己資本比率の計算
- バランスシート情報から自動計算
- 計算式: `総株主資本 / 総資産 × 100`
- データが取得できない場合のフォールバック処理

## 4. 非機能要件

### 4.1 パフォーマンス
- API呼び出し回数の最小化（quoteSummaryで一括取得）
- キャッシュ機能の検討（同一銘柄の重複リクエスト回避）

### 4.2 拡張性
- 新しい財務指標を容易に追加できるアーキテクチャ
- 既存のテクニカル指標ライブラリとの統合

### 4.3 エラーハンドリング
- Yahoo Finance API制限への対応
- データ欠損時の適切なエラーメッセージ
- タイムアウト処理

## 5. 制約事項

### 5.1 データソースの制約
- Yahoo Finance APIの利用規約に準拠
- 信用取引データは取得不可のため対象外

### 5.2 技術的制約
- 既存のプロジェクト構造を維持
- TypeScriptの型安全性を保持
- 既存のテスト構造との互換性

## 6. 成功基準
- 指定された8つの財務指標（信用取引除く）が正常に取得できる
- 移動平均乖離率とRSI期間拡張が正確に計算される
- エラーハンドリングが適切に機能する
- 既存機能への影響がない
- テストカバレッジが適切に維持される

## 7. 今後の拡張可能性
- 他の財務比率の追加
- 業界平均との比較機能
- 時系列データでのトレンド分析