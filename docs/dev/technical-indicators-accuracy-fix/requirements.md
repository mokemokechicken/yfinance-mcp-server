# 要件定義書: テクニカル指標計算精度向上

## 1. 概要

既存のテクニカル指標ライブラリ（MACD、RSI、移動平均）に対して、o3ツールによるレビューで発見された計算精度の問題を修正し、数学的正確性と実用性を向上させる。

## 2. 背景

o3ツールによる詳細レビューの結果、以下の重要な問題が発見された：
- MACD計算における致命的なインデックスずれ
- EMA初期値の非標準実装による市販チャートとの乖離
- エッジケース処理の不足
- パフォーマンス問題

## 3. 修正対象の問題

### 3.1 MACD計算の致命的なバグ（最重要）
**問題**: 短期EMAと長期EMAの同じ日付の値を比較していない
- 現在: `macdLine[i] = fastEMA[i] - slowEMA[i-14]` (14日ずれ)
- **影響**: 計算結果が完全に間違っている

### 3.2 EMA初期値の非標準実装
**問題**: 最初の値をそのまま使用
- 標準的には最初の期間の単純平均を使用すべき
- **影響**: 市販チャートソフトと結果が乖離

### 3.3 エッジケース処理不足
**問題**: 以下の場合の適切な処理が不足
- データ不足時（NaN/undefined発生）
- パラメータ0や負の値
- 空配列や不正データ

### 3.4 パフォーマンス問題
**問題**: 最新値のみ必要なのに全系列を計算
- **影響**: 大量データで時間・メモリ浪費

## 4. 機能要件

### 4.1 数学的正確性の確保
- [x] MACD: 同一日付のEMA値で差分計算
- [x] EMA: 業界標準の初期値計算方法を採用
- [x] RSI: Wilder's平滑化の正確な実装維持
- [x] 移動平均: 計算精度の維持

### 4.2 エラーハンドリングの強化
- [x] データ不足時の適切なエラー処理
- [x] 不正パラメータ（0以下の期間など）の検証
- [x] 空配列や不正データの処理
- [x] 明確なエラーメッセージの提供

### 4.3 パフォーマンス向上
- [x] 不要な全系列計算の削減
- [x] メモリ使用量の最適化
- [x] 計算効率の改善

### 4.4 市販チャートとの互換性
- [x] 一般的なチャートソフト（TradingView等）との結果一致
- [x] 業界標準アルゴリズムとの整合性

## 5. 非機能要件

### 5.1 品質
- [x] 既存テストケースの全パス維持
- [x] 新規テストケースによる修正内容の検証
- [x] エッジケースのテストカバレッジ向上

### 5.2 互換性
- [x] 既存APIインターフェースの維持
- [x] 既存呼び出し元コードの動作保証
- [x] TypeScript型定義の一貫性

### 5.3 保守性
- [x] コードの可読性向上
- [x] 計算ロジックの明確なドキュメント化
- [x] エラーケースの明確な処理

## 6. 影響範囲

### 6.1 修正対象ファイル
- `src/lib/technical-indicators/indicators/macd.ts`
- `src/lib/technical-indicators/indicators/rsi.ts`
- `src/lib/technical-indicators/indicators/movingAverage.ts`
- `src/lib/technical-indicators/utils/calculator.ts`

### 6.2 テスト影響
- 既存テストの結果変更（正確な計算結果への変更）
- 新規テストケースの追加

### 6.3 動作影響
- より正確な計算結果の提供
- エラーケースでの安定動作
- パフォーマンス向上

## 7. 制約事項

### 7.1 技術制約
- 既存のTypeScriptプロジェクト構造の維持
- 現在のビルド・テスト環境との互換性
- 外部依存関係の変更禁止

### 7.2 運用制約
- 既存機能の破壊的変更の回避
- 段階的な修正とテスト
- バックワード互換性の維持

## 8. 成功基準

### 8.1 数学的正確性
- [x] o3ツールによる再レビューでの問題解決確認
- [x] 市販チャートソフトとの計算結果一致（±0.1%以内）
- [x] 標準的な金融工学教科書の計算式との整合

### 8.2 品質向上
- [x] 全テストケースの成功（128個のテスト全パス）
- [x] エッジケースでのクラッシュゼロ
- [x] エラーハンドリングの適切な動作

### 8.3 パフォーマンス
- [x] 計算時間の20%以上短縮（大量データ時）
- [x] メモリ使用量の削減
- [x] CPU使用率の改善

## 9. リスク

### 9.1 高リスク
- 既存の呼び出し元での計算結果変更による影響
- テストケース大幅修正の必要性

### 9.2 中リスク  
- パフォーマンス改善による予期しない副作用
- エラーハンドリング変更による動作変化

### 9.3 対策
- 段階的修正とテスト
- 修正前後の詳細比較
- 十分なテストカバレッジの確保