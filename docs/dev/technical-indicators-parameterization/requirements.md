# 技術指標パラメータ化機能 要件定義書

## 1. 概要

現在の技術指標ライブラリでは多くの重要なパラメータ（期間、閾値等）がハードコードされており、カスタマイズができない状況です。本機能では、これらのパラメータを外部から設定可能にし、出力表現にも適切な日数表記を追加することで、より柔軟で実用的な分析を可能にします。

## 2. 現状の課題

### 2.1 ハードコードされたパラメータ
調査により以下のパラメータがハードコードされていることが判明：

#### 高優先度パラメータ
- **移動平均線期間**: [25, 50, 200]日（システム固定）
- **RSI期間**: [14, 21]日（システム固定）
- **MACD設定**: fastPeriod=12, slowPeriod=26, signalPeriod=9（固定）
- **ボリンジャーバンド**: period=20日, standardDeviations=2σ（固定）
- **ストキャスティクス**: kPeriod=14日, dPeriod=3日（固定）
- **出来高分析**: period=20日（固定）

#### 中優先度パラメータ
- RSI/ストキャスティクスの買われすぎ/売られすぎレベル
- 各種lookback/confirmation期間
- VWAP標準偏差設定
- 出来高急増閾値

### 2.2 出力表現の問題
- 現在の出力では使用した期間パラメータが不明確
- VWAPは1日計算が不可能なため、MVWAP(N日)表記に変更が必要
- ユーザーが設定した期間が結果に反映されない

## 3. 機能要件

### 3.1 パラメータ設定機能

#### 3.1.1 Tool引数での設定
`getStockAnalysis` toolに以下のoptionalパラメータを追加：

```typescript
interface StockAnalysisParams {
  symbol: string;                    // 既存（必須）
  days?: number;                     // 既存（オプション、デフォルト7）
  
  // 新規追加（すべてオプション）
  technicalParams?: {
    movingAverages?: {
      periods?: number[];            // デフォルト[25, 50, 200]
    };
    rsi?: {
      periods?: number[];            // デフォルト[14, 21]
      overbought?: number;           // デフォルト70
      oversold?: number;             // デフォルト30
    };
    macd?: {
      fastPeriod?: number;           // デフォルト12
      slowPeriod?: number;           // デフォルト26
      signalPeriod?: number;         // デフォルト9
    };
    bollingerBands?: {
      period?: number;               // デフォルト20
      standardDeviations?: number;   // デフォルト2
    };
    stochastic?: {
      kPeriod?: number;             // デフォルト14
      dPeriod?: number;             // デフォルト3
      overbought?: number;          // デフォルト80
      oversold?: number;            // デフォルト20
    };
    volumeAnalysis?: {
      period?: number;               // デフォルト20
      spikeThreshold?: number;       // デフォルト2.0
    };
    vwap?: {
      enableTrueVWAP?: boolean;      // デフォルトtrue（15分足ベース）
      standardDeviations?: number;   // デフォルト1
    };
    mvwap?: {
      period?: number;               // デフォルト20（移動期間）
      standardDeviations?: number;   // デフォルト1
    };
  };
}
```

#### 3.1.2 パラメータ検証
- 期間パラメータ: 1以上、データ期間以下
- 閾値パラメータ: 適切な範囲内（RSI: 0-100、倍率: >0等）
- 不正値の場合はデフォルト値を使用し、警告を出力

### 3.2 出力表現の改善

#### 3.2.1 日数表記の明確化
現在の表記を以下のように改善：

**Before:**
```
📊 移動平均線: 25日=1,234円, 50日=1,200円, 200日=1,150円
📈 RSI: 65.2
```

**After:**
```
📊 移動平均線
├─ 短期(25日): 1,234円 📈
├─ 中期(50日): 1,200円 ➡️
└─ 長期(200日): 1,150円 📉

📈 RSI
├─ RSI(14日): 65.2 ⚠️買われすぎ圏
└─ RSI(21日): 62.8 ⚡中立圏
```

#### 3.2.2 VWAP機能の拡張
Yahoo Finance API調査により、真の1日VWAPが計算可能であることが判明。両方を提供：

**A. 真の1日VWAP（新規追加）**
```
💧 VWAP(1日): 1,228円 ✨新機能
├─ 上部バンド(+1σ): 1,235円
├─ 下部バンド(-1σ): 1,221円
├─ データソース: 15分足 (過去60日間利用可能)
└─ 現在位置: 中央付近 ➡️
```

**B. 移動VWAP（従来機能の改善）**
```  
💧 MVWAP(20日): 1,215円
├─ 上部バンド(+1σ): 1,230円
├─ 下部バンド(-1σ): 1,200円
├─ データソース: 日足データ
└─ 現在位置: 上部寄り 🔼
```

**注意**: 真の1日VWAPは15分足データを使用し、過去60日間のみ利用可能

#### 3.2.3 カスタム設定の表示
ユーザーがデフォルトから変更した場合：
```
📊 移動平均線（カスタム設定）
├─ 短期(10日): 1,240円 📈
├─ 中期(30日): 1,210円 ➡️
└─ 長期(100日): 1,180円 📉
```

### 3.3 後方互換性
- 既存のAPI呼び出しは変更なく動作
- パラメータ未指定時はデフォルト値を使用
- 既存の出力形式も維持（新形式は追加として実装）

## 4. 非機能要件

### 4.1 拡張性要件
- 新しい指標追加時も同様のパラメータ化が容易
- 設定オブジェクトの拡張が容易

### 4.2 ユーザビリティ要件
- パラメータ設定ミス時の明確なエラーメッセージ
- デフォルト値の適切な選択
- ドキュメント化された設定例

## 5. 制約事項

### 5.1 技術的制約
- Yahoo Finance APIのデータ制限内での動作
- 既存のGraceful Degradation機能を維持
- TypeScript型安全性の維持

### 5.2 ビジネス制約
- 既存機能の動作変更は不可
- API仕様の大幅変更は避ける

## 6. 受け入れ基準

### 6.1 機能面
- [ ] Tool引数でのパラメータ設定が動作する
- [ ] 設定されたパラメータが出力に正しく反映される
- [ ] パラメータ未指定時はデフォルト値で動作する
- [ ] 不正パラメータ時は警告付きでデフォルト値を使用

### 6.2 出力面
- [ ] 各指標の期間が出力に明記される
- [ ] 真の1日VWAPと移動VWAP(N日)の両方が提供される
- [ ] カスタム設定時に「カスタム設定」が表示される
- [ ] 日本語レポートが適切に更新される

### 6.3 品質面
- [ ] 既存のテストがすべて通過する
- [ ] 新機能のテストケースが追加される
- [ ] TypeScript型チェックが通る
- [ ] Lintエラーが存在しない

### 6.4 パラメータ渡しテスト
- [ ] `TechnicalAnalyzer.analyzeStockComprehensive`への技術指標パラメータ渡しが正しく動作する
- [ ] カスタムパラメータが個別指標計算メソッドまで正しく伝播される
- [ ] パラメータ未指定時はデフォルト値が使用される
- [ ] 無効なパラメータ値は適切にデフォルト値に修正される
- [ ] 部分的なパラメータ設定（一部の指標のみカスタム）が正しく処理される
- [ ] 下位互換性が保たれている（既存の呼び出し方法が動作する）

## 7. 実装フェーズ

### Phase 1: 高優先度パラメータ（MVP）
- 移動平均線、RSI、MACD、ボリンジャーバンドの期間設定
- 基本的な出力表記改善

### Phase 2: 中優先度パラメータ
- 閾値パラメータの設定
- より詳細な出力表現

### Phase 3: 低優先度パラメータ
- 内部計算パラメータの設定

## 8. リスク分析

### 8.1 技術リスク
- **リスク**: 新しい15分足API呼び出しによるレート制限への影響
- **対策**: キャッシュ機能の実装、Graceful Degradation、段階的実装

- **リスク**: 真の1日VWAPの計算複雑度増加
- **対策**: 適切なエラーハンドリングとフォールバック機能

### 8.2 ユーザビリティリスク
- **リスク**: パラメータ設定の複雑化
- **対策**: 適切なデフォルト値とドキュメント整備

### 8.3 その他のリスク
- **リスク**: 設定検証による軽微なオーバーヘッド
- **対策**: 効率的な検証ロジックの実装